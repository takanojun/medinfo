# 📘 Codex指示書：メモ帳アプリへの画像機能追加と保存形式（PostgreSQL bytea）実装

## 概要

このプロジェクトはMarkdown対応のメモ帳アプリです。  
メモに画像を追加・表示・編集できる機能を実装し、画像データは**PostgreSQLの`bytea`型（Blob）**で保存してください。  
**base64形式での保存は使用しません。**

---

## ✅ 実装要件

### 1. 画像追加方法

以下の操作で画像をメモ本文に追加できるようにします：

- ドラッグ＆ドロップで画像ファイルを追加
- ファイル選択ダイアログで画像を追加
- クリップボードからの貼り付け（Ctrl+V）
- 右クリックメニューから貼り付け

---

### 2. 表示・編集機能

追加された画像に対して以下の操作を可能とします：

- 本文中でプレビュー表示
- リサイズ（マウスドラッグ）
- ドラッグ＆ドロップによる画像の位置変更
- 右クリックメニューから削除

---

### 3. モーダル表示（画像拡大）

画像をクリックするとモーダルビューを開き、以下の操作が可能：

- 拡大・縮小
- 左右回転
- モーダル右上に「×」ボタンを設置し、クリックで閉じる

---

### 4. 保存形式（PostgreSQLの`bytea`型）

画像データはメモ本文とは**別テーブル**に保存し、以下の情報を含みます：

- 一意の画像ID（UUIDなど）
- 関連するメモID
- ファイル名
- MIMEタイプ（例：image/png）
- バイナリ画像データ（`bytea`型）
- 作成日時などのメタ情報

> 画像は**base64にエンコードせず、そのままのバイナリ形式で保存すること**。

---

### 5. メモ本文への画像参照

メモ本文中には、画像の表示位置に以下のような形式で埋め込みます：


- 表示時は、該当する画像IDを用いてデータベースから画像データを取得し、`<img>`タグに設定して表示してください。
- クライアント側で画像を表示するために、画像APIのエンドポイントを通じてBlobデータを受け取り、`URL.createObjectURL()`などを使用して描画してください。

---

### 6. Undo / Redo 対応

以下の画像操作はすべてUndo/Redo機能に対応させ、既存のテキスト編集履歴と統合します：

- 画像の追加／削除
- リサイズ
- 位置変更

---

## 🔐 セキュリティ・バリデーション

- 対応ファイル形式：png, jpeg, gif, webp, svg など
- 拡張子とMIMEタイプのバリデーションを実装
- SVGに対してはJavaScript等のスクリプトを無効化（XSS対策）

---

## 🛠 推奨タスク分割

1. `note_images` テーブルの作成（`bytea`型による画像保存）
2. フロントエンドでの画像アップロード処理（各入力手段対応）
3. プレビュー・リサイズ・位置変更・削除機能の実装
4. 本文中に画像IDを挿入する機構の構築
5. モーダルビュー機能（画像拡大・回転・閉じる）
6. Undo/Redoへの統合対応
7. MIME/サイズバリデーションとXSS対策

---

## 備考

- 本指示書では画像保存は`bytea`型によるBlob保存のみを使用します。base64形式は使用しません。
- 本文中には画像IDで参照を埋め込み、BlobデータはAPI経由で取得して描画します。
- パフォーマンス最適化やキャッシュ機能は将来的な追加タスクとします。
